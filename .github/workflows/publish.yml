name: publish

on:
  push:
    branches: [ main ]
    paths-ignore:
      - README.md
      - LICENSE
      - NOTICE.md
      - .devcontainer/**
      - benchmarks/**
      - docs/**
      - templates/**
      - .github/ISSUE_TEMPLATE/**
      - .github/PULL_REQUEST_TEMPLATE.md
    tags: ["[0-9]+.[0-9]+.[0-9]+"]

permissions:
  contents: read
  id-token: write

jobs:
  pack_and_publish:
    runs-on: ubuntu-latest
    environment: nuget
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "8.0.x"

      - name: Compute SemVer
        id: v
        shell: bash
        run: |
          set -e

          LAST_TAG=$(git describe --tags --abbrev=0 --match "[0-9]*.[0-9]*.[0-9]*" 2>/dev/null || echo 0.1.0)
          IFS=. read -r MA MI PA <<< "$LAST_TAG"

          if git rev-parse "$LAST_TAG" >/dev/null 2>&1; then
            RANGE="${LAST_TAG}..HEAD"
          else
            RANGE="HEAD"
          fi

          LOG=$(git log --pretty=%B $RANGE)

          if [[ "$LOG" == *"[major]"* ]]; then
            MA=$((MA+1)); MI=0; PA=0
          elif [[ "$LOG" == *"[minor]"* ]]; then
            MI=$((MI+1)); PA=0
          else
            PA=$((PA+1))
          fi

          if [[ "${GITHUB_REF}" =~ refs/tags/([0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            PKG_VERSION="${BASH_REMATCH[1]}"
          else
            if git rev-parse "$LAST_TAG" >/dev/null 2>&1; then
              COUNT=$(git rev-list --count "${LAST_TAG}..HEAD")
            else
              COUNT=$(git rev-list --count HEAD)
            fi

            if [[ "$COUNT" -lt 1 ]]; then
              COUNT=1
            fi

            PKG_VERSION="$MA.$MI.$PA-rc.$COUNT"
          fi

          echo "PKG_VERSION=$PKG_VERSION" | tee -a "$GITHUB_ENV"
          echo "version=$PKG_VERSION" >> "$GITHUB_OUTPUT"

      - name: Build
        run: dotnet build Liaison.Messaging.sln -c Release

      - name: Pack
        run: |
          mkdir -p artifacts
          for project in src/*/*.csproj; do
            dotnet pack "$project" \
              -c Release \
              --no-build \
              -o artifacts \
              -p:PackageVersion=${{ env.PKG_VERSION }} \
              -p:IncludeSymbols=true \
              -p:SymbolPackageFormat=snupkg
          done

      - name: NuGet Login
        uses: NuGet/login@v1
        id: nuget_login
        with:
          user: asp2286

      - name: Publish nupkg to nuget.org (Trusted Publishing)
        run: dotnet nuget push "artifacts/*.nupkg" --source https://api.nuget.org/v3/index.json --api-key ${{ steps.nuget_login.outputs.NUGET_API_KEY }} --skip-duplicate

      - name: Publish snupkg to nuget.org (Trusted Publishing)
        run: dotnet nuget push "artifacts/*.snupkg" --source https://api.nuget.org/v3/index.json --api-key ${{ steps.nuget_login.outputs.NUGET_API_KEY }} --skip-duplicate
